<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tasmania</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
      integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14="
      crossorigin=""
    />

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
      integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg="
      crossorigin=""
    ></script>

    <!-- D3 JS -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />

    <!-- Our CSS -->
    <link rel="stylesheet" type="text/css" href="static/css/style.css" />
  </head>
  <body>
    <!-- Add Navbar -->
    <nav class="navbar sticky-top navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="/">Home</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNavDropdown"
        aria-controls="navbarNavDropdown"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div
        class="collapse navbar-collapse justify-content-end"
        id="navbarNavDropdown"
      >
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              id="navbarDropdownMenuLink"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
            >
              States
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
              <a class="dropdown-item" href="/act"
                >Australian Capital Territory</a
              >
              <a class="dropdown-item" href="/nsw">New South Wales</a>
              <a class="dropdown-item" href="/nt">Northern Territory</a>
              <a class="dropdown-item" href="/qld">Queensland</a>
              <a class="dropdown-item" href="/sa">South Australia</a>
              <a class="dropdown-item" href="/tas">Tasmania</a>
              <a class="dropdown-item" href="/vic">Victoria</a>
              <a class="dropdown-item" href="/wa">Western Australia</a>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/comparisons">Comparisons</a>
          </li>
        </ul>
      </div>
    </nav>

    <div>
      <canvas
        id="myChart"
        style="height: 300px; width: 700px !important"
      ></canvas>
    </div>

    <!-- Bootstrap JavaScript plugins -->
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>

    <!-- Import Chart.js library and it's annotation plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>

    <script>
      const ctx = document.getElementById("myChart");
      var tas_data = d3.json("/tasdata");
      console.log(tas_data);

      // Creating arrays to hold data
      let dates = [];
      let dateOnly = [];
      let currCases = [];
      let currRAT = [];
      let deaths = [];
      let hosp = [];
      let icu = [];
      let newCases = [];
      let newRAT = [];
      let vent = [];

      // Registering the Chart.js annotation plugin
      Chart.register("chartjs-plugin-annotation");

      // Creating the sortResponse function
      function sortResponse(data) {
        for (var i = 0; i < Object.keys(data).length; i++) {
          // Looping through the retrieved JSON data and appending to arrays (unshift is used to ensure data is in the correct order)
          dates.unshift(data[i]["DATE"]);
          currCases.unshift(data[i]["CURRENT CASES"]);
          currRAT.unshift(data[i]["CURRENT RAT CASES"]);
          deaths.unshift(data[i]["DEATHS"]);
          hosp.unshift(data[i]["HOSP"]);
          icu.unshift(data[i]["ICU"]);
          newCases.unshift(data[i]["NEW CASES"]);
          newRAT.unshift(data[i]["NEW RAT CASES"]);
          vent.unshift(data[i]["VENT"]);
        }
      }

      // Retrieving JSON data, then calling sortResponse on it
      tas_data.then(function (data) {
        sortResponse(data);
        console.log(dates);

        // Removing time from dates
        for (var i = 0; i < dates.length; i++) {
          var date = new Date(dates[i]);
          var noTime = date.toLocaleDateString("en-AU");
          dateOnly.push(noTime)
        };

        // Creating a line chart with the data
        new Chart(ctx, {
          type: "line",
          data: {
            labels: dateOnly,
            datasets: [
              {
                label: "New Cases",
                data: newCases,
              },
              {
                label: "New RAT Cases",
                data: newRAT,
                hidden: true,
              },
              {
                label: "Total Cases",
                data: currCases,
                hidden: true,
              },
              {
                label: "Total RAT Cases",
                data: currRAT,
                hidden: true,
              },
              {
                label: "Hospitalisations",
                data: hosp,
              },
              {
                label: "ICU Admissions",
                data: icu,
                hidden: true,
              },
              {
                label: "Patients requiring ventilation",
                data: vent,
                hidden: true,
              },
              {
                label: "Deaths",
                data: deaths,
              },
            ],
          },
          options: {
            plugins: {
              // Using the annotation plugin to annotate the graph
              annotation: {
                annotations: {
                  line1: {
                    type: "line",
                    mode: "vertical",
                    label: {
                      enabled: true,
                      content: ["Apr 12, 2020:", "Burnie outbreak", "leads to business restrictions"],
                      display: true,
                      color: "#000000",
                      backgroundColor: "#EEEEEE",
                      position: 'start',
                    },
                    xMin: "13/04/2020",
                    xMax: "13/04/2020",
                    borderColor: "#56A6A6",
                    borderWidth: 2,
                  },
                  line2: {
                    type: "line",
                    mode: "vertical",
                    label: {
                      enabled: true,
                      content: ["Oct 15, 2021:", "1st Lockdown"],
                      display: true,
                      color: "#000000",
                      backgroundColor: "#EEEEEE",
                      position: 'start',
                    },
                    xMin: "18/10/2021",
                    xMax: "18/10/2021",
                    borderColor: "#56A6A6",
                    borderWidth: 2,
                  },
                  line3: {
                    type: "line",
                    mode: "vertical",
                    label: {
                      enabled: true,
                      content: ["Dec 15, 2021:", "Border re-opens", "for all domestic travel"],
                      display: true,
                      color: "#000000",
                      backgroundColor: "#EEEEEE",
                      position: 'start',
                      yAdjust: 50,
                    },
                    xMin: "29/11/2021",
                    xMax: "29/11/2021",
                    borderColor: "#56A6A6",
                    borderWidth: 2,
                  },
                  line4: {
                    type: "line",
                    mode: "vertical",
                    label: {
                      enabled: true,
                      content: ["Dec 19, 2021:", "Tasmania reaches", "95% vaccination coverage" ],
                      display: true,
                      color: "#000000",
                      backgroundColor: "#EEEEEE",
                      position: 'start',
                      yAdjust: 110,
                    },
                    xMin: "13/12/2021",
                    xMax: "13/12/2021",
                    borderColor: "#56A6A6",
                    borderWidth: 2,
                  },
                },
              },
            },
            responsive: true,
          },
        });
      });
    </script>
  </body>
</html>
